{{- /* Set defaults. */}}
{{- $dir := "images/random" }}
{{- $format := "webp" }}
{{- $height := 360 }}
{{- $width := 640 }}

{{- /* Get params. */}}
{{- with .Get "dir" }}
  {{- $dir = . }}
{{- end }}
{{- with .Get "format" }}
  {{- $format = . }}
{{- end }}
{{- with .Get "height" }}
  {{- $height = . | int }}
{{- end }}
{{- with .Get "width" }}
  {{- $width = . | int }}
{{- end }}

{{- /* Build slice of processed images. */}}
{{- $images := slice }}
{{- range resources.Match (printf "%s/*" $dir) }}
  {{- with .Fill (printf "%dx%d %s" $width $height $format) }}
    {{- $m := dict
      "alt" (path.BaseName .Name | humanize | title)
      "height" .Height
      "relPermalink" .RelPermalink
      "width" .Width
    }}
    {{- $images = $images | append $m }}
  {{- end }}
{{- end }}

{{- /* Render first image in slice. */}}
{{- with index $images 0 }}
  <img
    id="random-img"
    src="{{ .relPermalink }}"
    width="{{ .width }}"
    height="{{ .height }}"
    alt="{{ .alt }}"
    onclick="shuffleImage()"
  >
{{- end }}

<script>
  function shuffleImage() {
    const images = {{ $images }};
    let index = sessionStorage.getItem('index');
    while (sessionStorage.getItem('index') == index) {
      index = Math.floor(Math.random() * images.length);
    }
    sessionStorage.setItem('index', index);
    const image = images[index];
    const el = document.getElementById('random-img');
    el.setAttribute('alt', image.alt)
    el.setAttribute('src', image.relPermalink)
    el.setAttribute('width', image.width)
    el.setAttribute('height', image.height)
  }
  if (!sessionStorage.getItem('index')) {
    sessionStorage.setItem('index',0)
  }
  shuffleImage();
</script>
