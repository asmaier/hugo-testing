{{- /**
Renders a random image, changing the image on click or page refresh.

You can invoke the shortcode multiple times on a page.

Place this before the closing body tag in layouts/_default/baseof.html:

  {{ if .HasShortcode "random-image" }}
    {{ with resources.Get "js/random-image.js" }}
      <script src="{{ .RelPermalink }}"></script>
    {{ end }}
  {{ end }}

Place this in assets/js/random-image.js:

  function shuffleImage(el) {
    let key = el.id + '-index';
    let lastIndex = sessionStorage.getItem(key)
    const images = JSON.parse(el.dataset.images);
    while (true) {
      index = Math.floor(Math.random() * images.length);
      if (index != lastIndex) {
        break;
      }
    }
    sessionStorage.setItem(key, index);
    const image = images[index];
    el.alt = image.alt;
    el.src = image.src;
    el.width = image.width;
    el.height = image.height;
  }

  window.onload = function() {
    els = document.getElementsByClassName('random-image');
    [...els].forEach((el) => {
      // Preload images.
      const images = JSON.parse(el.dataset.images);
      images.forEach((img) => {
        new Image().src = img.src;
      });
      // Shuffle images.
      shuffleImage(el);
    });
  }

@param {string} [dir=images/random] The directory, relative to the assets directory, in which the images reside.
@param {string} [format=webp] The final image format. Valid values are bmp, gif, jpg, jpeg, png, and webp.
@param {int} [height=360] The height of the rendered image.
@param {int} [width=640] The width of the rendered image.

@example {{< random-image >}}
@example {{< random-image dir="images/kittens" format="jpg" height=200 width=200 >}}
*/}}

{{- /* Set defaults. */}}
{{- $dir := "images/random" }}
{{- $format := "webp" }}
{{- $height := 360 }}
{{- $width := 640 }}

{{- /* Get params. */}}
{{- with .Get "dir" }}
  {{- $dir = . }}
{{- end }}
{{- with .Get "format" }}
  {{- $format = . | lower }}
{{- end }}
{{- with .Get "height" }}
  {{- $height = . | int }}
{{- end }}
{{- with .Get "width" }}
  {{- $width = . | int }}
{{- end }}

{{- /* Error checking. */}}
{{- $validFormats := slice "bmp" "gif" "jpeg" "jpg" "png" "webp" }}
{{- if not (in $validFormats $format) }}
  {{- errorf "The %q shortcode was called with an invalid image format. See %s" .Name .Position }}
{{- end }}

{{- /* Build slice of processed images. */}}
{{- $images := slice }}
{{- range resources.Match (printf "%s/*" $dir) }}
  {{- with .Fill (printf "%dx%d %s" $width $height $format) }}
    {{- $m := dict
      "alt" (path.BaseName .Name | humanize | title)
      "height" .Height
      "src" .RelPermalink
      "width" .Width
    }}
    {{- $images = $images | append $m }}
  {{- end }}
{{- else }}
  {{- errorf "The %q shortcode was unable to load images from the %q directory. See %s" .Name $dir .Position }}
{{- end }}

{{- /* Render placeholder image (1px transparent GIF). */ -}}
<img
  alt=""
  class="{{ .Name }}"
  id="{{ printf "%s-%d" .Name .Ordinal }}"
  src="data:image/gif;base64,R0lGODlhAQABAPAAAAAAAAAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw=="
  width="{{ $width }}"
  height="{{ $height }}"
  data-images="{{ $images | jsonify }}"
  onclick="shuffleImage(this)"
>
{{- /**/ -}}
